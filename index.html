<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Divine Cosmic Voice</title>
<script src="https://sdk.puter.com/v2/puter.js"></script>
<style>
html,body{margin:0;padding:0;overflow:hidden;height:100%;background:#000;font-family:sans-serif;}
canvas#bg{position:fixed;inset:0;z-index:0;}
#ui{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:10;pointer-events:none;}
#chakraWrap{pointer-events:auto;width:200px;height:200px;cursor:pointer;display:flex;align-items:center;justify-content:center;position:relative;}
#chakra svg{width:100%;height:100%;}
#overlay{position:fixed;inset:0;z-index:20;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);color:#fff;flex-direction:column;gap:15px;padding:20px;text-align:center;}
#enterBtn{padding:14px 22px;font-size:18px;border:none;border-radius:999px;background:linear-gradient(90deg,#ffd966,#ff9b33);color:#000;cursor:pointer;font-weight:800;}
#status{position:fixed;top:10px;left:10px;color:#fff;background:rgba(0,0,0,0.5);padding:6px 12px;border-radius:12px;font-size:13px;pointer-events:none;}
</style>
</head>
<body>
<canvas id="bg"></canvas>

<div id="ui">
  <div id="chakraWrap" title="Tap to speak">
    <svg viewBox="0 0 200 200">
      <defs>
        <radialGradient id="grad" cx="35%" cy="35%">
          <stop offset="0" stop-color="#fff9e6"/>
          <stop offset="0.35" stop-color="#ffebc2"/>
          <stop offset="1" stop-color="#ff8b2b"/>
        </radialGradient>
        <path id="bladePath" d="M2,-78 C12,-60 24,-42 26,-20 C18,-16 8,0 4,20 C0,0 -6,-16 -14,-20 C-12,-40 -2,-60 2,-78 Z"/>
      </defs>
      <circle cx="100" cy="100" r="86" fill="url(#grad)" stroke="#ffd88c" stroke-width="3"/>
      <g id="blades" transform="translate(100,100)"></g>
      <circle cx="100" cy="100" r="18" fill="#ffefc9" stroke="#ffd07a" stroke-width="2"></circle>
    </svg>
  </div>
</div>

<div id="overlay">
  <div id="welcomeText">Welcome! Please enter your name:</div>
  <input type="text" id="userName" placeholder="Enter name" style="padding:10px;font-size:16px;border-radius:6px;border:none;width:160px;text-align:center"/>
  <button id="enterBtn">Start Divine Voice</button>
</div>

<div id="status">Initializing...</div>

<script>
const canvas=document.getElementById('bg');
const ctx=canvas.getContext('2d');
let W=canvas.width=window.innerWidth;
let H=canvas.height=window.innerHeight;

const overlay=document.getElementById('overlay');
const enterBtn=document.getElementById('enterBtn');
const status=document.getElementById('status');
const chakraWrap=document.getElementById('chakraWrap');
const blades=document.getElementById('blades');

let userName='';
let aiAssistant=null, aiSession=null;
let conversation=[]; // stored in-memory

// ---------- Cosmic stars ----------
const stars=[];
for(let i=0;i<200;i++) stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.5+0.2,hue:200+Math.random()*80});

// ---------- Chakra blades ----------
(function createBlades(){
  for(let i=0;i<12;i++){
    const use=document.createElementNS('http://www.w3.org/2000/svg','use');
    use.setAttributeNS('http://www.w3.org/1999/xlink','href','#bladePath');
    use.setAttribute('transform',`rotate(${(360/12)*i})`);
    use.setAttribute('fill','#ffebc2');
    blades.appendChild(use);
  }
})();

// ---------- Puter AI Init ----------
async function initPuterAI(){
  if(!window.puter) return false;
  aiAssistant=await puter.ai.createAssistant({
    name:"DivineCosmicGuru",
    instructions:`You are a saintly cosmic advisor. Answer users as if you are a sage. Deliver Sanatan scriptures teachings. Use the user's name when responding.`
  });
  aiSession=await aiAssistant.createSession();
  return true;
}

// ---------- Speak ----------
async function speak(text){
  if(!window.puter) return speechSynthesis.speak(new SpeechSynthesisUtterance(text));
  const audio=await puter.ai.txt2speech(text,{voice:'alloy_female',language:'hi-IN',ssml:false});
  if(audio instanceof HTMLAudioElement) await audio.play();
}

// ---------- STT ----------
let recognition=null;
function startListening(){
  if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {status.textContent='STT unsupported'; return;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recognition=new SR();
  recognition.lang='hi-IN';
  recognition.interimResults=false;
  recognition.maxAlternatives=1;
  recognition.onresult=async e=>{
    const spoken=e.results[0][0].transcript;
    conversation.push({role:'user',text:spoken});
    status.textContent='Thinking...';
    let aiText='Main iska jawab nahi de sakta.';
    try{
      const resp=await aiSession.prompt(`User Name:${userName}\nPrevious:${conversation.map(c=>c.role+":"+c.text).join('\n')}\nUser:${spoken}`);
      aiText=resp.output_text||resp.text||aiText;
    }catch(e){ console.warn(e);}
    conversation.push({role:'assistant',text:aiText});
    await speak(aiText);
    startListening();
  };
  recognition.onend=()=>recognition.start();
  recognition.start();
  status.textContent='Listening...';
}

// ---------- Chakra click ----------
chakraWrap.addEventListener('click',()=>{
  if(!aiSession) return;
  if(!recognition) startListening();
});

// ---------- Start button ----------
enterBtn.addEventListener('click',async()=>{
  userName=document.getElementById('userName').value.trim()||'Yatri';
  overlay.style.display='none';
  await initPuterAI();
  await speak(`नमस्ते ${userName}, मैं आपका दिव्य मार्गदर्शक हूँ। जब आप तैयार हों, बोलें; मैं आपको सनातन परंपरा का ज्ञान दूँगा।`);
  startListening();
});

// ---------- Cosmic animate ----------
function animate(){
  requestAnimationFrame(animate);
  ctx.fillStyle='#000';
  ctx.fillRect(0,0,W,H);
  stars.forEach(s=>{
    s.y-=0.3;
    if(s.y<0)s.y=H;
    ctx.beginPath();
    ctx.fillStyle=`hsl(${s.hue},80%,70%)`;
    ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
    ctx.fill();
  });
  const now=performance.now()/1000;
  blades.setAttribute('transform',`translate(100,100) rotate(${now*50})`);
}
animate();

// ---------- Responsive ----------
window.addEventListener('resize',()=>{W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;});
</script>
</body>
</html>
